{% extends 'index.html.twig' %}

{% block title %}Bris de porte : tester mon éligibilité{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <script src="{{ asset('build/alpinejs/cdn.js') }}" defer></script>
    <style>
        .fr-text--underlined {
            text-decoration: underline;
        }
        /**
        @keyframes spin {
            from {
                transform:rotate(0deg);
            }
            to {
                transform:rotate(360deg);
            }
        }
        */

        /* AlpineJS */
        [x-cloak] {
            display: none !important;
        }
    </style>
{% endblock stylesheets %}

{% block modale %}
<dialog aria-labelledby="modale-test-eligibilite-title" id="modale-test-eligibilite" class="fr-modal" role="dialog"
        data-fr-opened="true">
    <div class="fr-container fr-container--fluid fr-container-md">
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12 fr-col-md-8 fr-col-lg-8">
                <div class="fr-modal__body">
                    <form
                        name="eligibilite-test-form"
                        action="{{ url(app.current_route) }}"
                        method="POST"
                        x-data="eligibiliteTestForm()"
                        {# x-init="$watch('reponses', )" #}
                    >
                        <div class="fr-modal__header">
                            <button
                                class="fr-btn--close fr-btn"
                                aria-controls="modale-test-eligibilite"
                                type="button"
                                @click="reinitialiser()"
                            >Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-title-foo-modal" class="fr-modal__title">Tester mon éligibilité à l'indemnisation</h1>

                            <p x-show="false">
                                La porte de votre logement a été fracturé par les forces de police dans le cadre d'une opération judiciaire.
                            </p>

                            {# Questions #}
                            <template x-for="(question, index) in questions">
                                <div class="fr-col-12" x-show="!decision && (estActive(question) || estRepondue(question))">
                                    <label x-text="question.label" class="fr-text--lg fr-text--underlined"></label>

                                    <ul class="fr-btns-group fr-btns-group--inline fr-btns-group--sm fr-btns-group--right fr-mt-2w">
                                        <template x-for="reponse in question.reponses" :key="`question-${index}`">
                                            <li>
                                                <button
                                                    class="fr-btn fr-btn--secondary"
                                                    :class="{ 'fr-btn--secondary': reponses[question.champs] !== reponse.valeur }"
                                                    type="button"
                                                    @click="repondre(question, reponse)"
                                                    x-text="reponse.libelle"
                                                ></button>
                                            </li>
                                        </template>
                                    </ul>

                                    <div class="fr-alert fr-alert--info fr-alert--sm fr-mt-2w " x-show="question.info">
                                        <p class="fr-py-2" x-html="question.info"></p>
                                    </div>
                                </div>
                            </template>

                            {# Décisions #}
                            <div
                                class="fr-alert"
                                :class="decision ? `fr-alert--${decision?.type}` : null"
                                x-show="!!decision"
                                x-cloak
                            >
                                <h3 class="fr-alert__title" x-text="decision?.titre"></h3>
                                <p x-html="decision?.message"></p>
                            </div>
                        </div>

                        <div class="fr-modal__footer">
                            <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-lg">
                                <button
                                    x-show="true"
                                    x-cloak
                                    class="fr-btn fr-btn--tertiary-no-outline"
                                    aria-controls="modale-test-eligibilite"
                                    data-fr-js-modal-button="true"
                                    @click="reinitialiser()"
                                    type="button"
                                >Annuler
                                </button>
                                <button
                                    class="fr-btn"
                                    type="submit"
                                    :disabled="!decision || !(decision?.eligible || true)"
                                    x-cloak
                                >Faire ma demande
                                </button>

                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</dialog>
{% endblock modale %}

{% block appelAAction %}
    <button class="fr-btn fr-p-3v" data-fr-opened="false" aria-controls="modale-test-eligibilite">
        <span class="text-center full-width">Déposer votre demande d’indemnisation</span>
    </button>
{% endblock appelAAction %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        function eligibiliteTestForm() {
            return {
                reponses: {},
                decision: null,
                estApplicable(question) {
                    /** Une question est applicable si elle n'a pas de champs fonction `condition` définie ou si
                     * est satisfaite par l'état actuel des réponses du questionnaire.
                     */
                    return !question.condition || question.condition(this.reponses);
                },
                estActive(question) {
                    /**
                     * Une question est active si elle est applicable, pas encore répondue et si toutes les questions
                     * précédentes ont une réponse ou ne sont pas applicables.
                     */
                    return !this.estRepondue(question) &&
                        this.estApplicable(question) &&
                        this.questions.slice(0, this.questions.indexOf(question)).every(
                            (questionPrecedente) => this.estRepondue(questionPrecedente) || !this.estApplicable(questionPrecedente)
                        );
                },
                estRepondue(question) {
                    return ![null, undefined].includes(this.reponses[question.champs]);
                },
                repondre(question, reponse) {
                    if (this.reponses[question.champs] === reponse.valeur) {
                        this.reponses[question.champs] = null;
                    } else {
                        this.reponses[question.champs] = reponse.valeur;
                    }
                    // Supprimer les réponses aux questions suivantes (cas du changement de réponse)
                    for (let champs of Array.from(this.questions.slice(this.questions.indexOf(question) + 1).map((q) => q.champs))) {
                        delete this.reponses[champs];
                    }

                    // Recalculer ?
                    this.decision = this.decisions.find((decision) => decision.condition(this.reponses)) ?? null;
                },
                questions: [
                    {
                        label: "Êtes-vous la personne visée par l'opération des forces de l'ordre ?",
                        champs: 'estVise',
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ]
                    },
                    {
                        label: "Est-ce que la personne recherchée réside ou est hébergée à cette adresse ?",
                        champs: 'estRecherche',
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ]
                    },
                    {
                        label: "Quel est votre statut par rapport au logement ?",
                        champs: "statut",
                        reponses: [
                            {
                                libelle: "Propriétaire occupant",
                                valeur: 'PROPRIETAIRE_OCCUPANT'
                            },
                            {
                                libelle: "Propriétaire bailleur",
                                valeur: 'PROPRIETAIRE_BAILLEUR'
                            },
                            {
                                libelle: "Locataire",
                                valeur: 'LOCATAIRE'
                            }
                        ],
                    },
                    {
                        label: "Votre locataire était-elle la personne recherchée ?",
                        condition: (reponses) => reponses?.statut === 'PROPRIETAIRE_BAILLEUR',
                        champs: "estLocataireVise",
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ],
                    },
                    {
                        label: "Avez-vous engagé sa responsabilité contractuelle ?",
                        condition: (reponses) => reponses?.statut === 'PROPRIETAIRE_BAILLEUR' && reponses.estLocataireVise,
                        info: "Vous pouvez engager sa responsabilité contractuelle (article 1732 du code civil)",
                        champs: "engageResponsabiliteLocataire",
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ],
                    },
                    {
                        label: "Avez-vous pris contact avec votre assurance habitation ?",
                        champs: "contacteAssurance",
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ],
                    },
                    {
                        label: "Avez-vous l'attestation de non prise en charge du sinistre par votre assurance ?",
                        champs: "attestationAssurance",
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ],
                    },
                    {
                        label: "Avez-vous pris contact avec votre bailleur ?",
                        condition: (reponses) => reponses?.statut === 'LOCATAIRE',
                        info: "Celui-ci a, à votre égard, une obligation de sécurité (article 1720 du code civil)",
                        champs: "contacteBailleur",
                        reponses: [
                            {
                                libelle: "Oui",
                                valeur : true,
                            },
                            {
                                libelle: "Non",
                                valeur : false,
                            }
                        ],
                    }
                ],
                decisions: [
                    {
                        type: "error",
                        condition: (reponses) => reponses?.estVise === true,
                        eligible: false,
                        titre: "Vous n'êtes pas éligible",
                        message: "[CONCERNÉ ERREUR]<br/><br/>En étant concerné par l'opération de police judiciaire, vous ne pouvez prétendre à une quelconque indemnisation.<br/>"
                    },
                    {
                        type: "error",
                        condition: (reponses) => reponses?.estRecherche === true,
                        eligible: false,
                        titre: "Vous n'êtes pas éligible",
                        message: "[RECHERCHÉ ERREUR]<br/><br/>Si la personne recherchée réside oh est hébergée dans le logement dont la porte a été fracturée dans le cadre l'opération de police judiciaire, vous ne pouvez prétendre à une quelconque indemnisation.<br/>"
                    },
                    // Cas non contacté assurance
                    {
                        type: "warning",
                        titre: "Contactez votre assurance",
                        condition: (reponses) => reponses?.statut !== 'LOCATAIRE' && reponses?.contactAssurance === false,
                        message: "[PAS ENCORE CONTACTE ASSURANCE]<br/><br/>Faites-le c'est mieux",
                    },
                    // Cas sans attestation assurance
                    {
                        type: "warning",
                        titre: "Rapprochez-vous de votre assurance",
                        condition: (reponses) => reponses?.statut !== 'LOCATAIRE'  && reponses?.attestationAssurance === false,
                        message: "[PAS ENCORE CONTACTE ASSURANCE]<br/><br/>Afin d'obtenir l'attestation de non-prise en charge. Celle-ci est nécessaire pour valider une indemnisation de notre part.",
                    },
                    // Cas ok tout va bien
                    {
                        type: "success",
                        condition: (reponses) => {
                            return (reponses?.statut === 'LOCATAIRE' && ![null, undefined].includes(reponses.contacteBailleur))
                                || (reponses.attestationAssurance)
                            ;
                        },
                        titre: "Vous êtes éligible",
                        message: "[OK]<br/><br/>Vous remplissez tous les critères pour déposer un dossier de demande d'indemnisation.<br/><br/>Nous vous invitons à créer un compte dès maintenant en cliquant sur le bouton ci-dessous."
                    }
                ],
                reinitialiser() {
                    this.reponses = {};
                    this.decision = null;
                }
            };
        };
    </script>
{% endblock javascripts %}
