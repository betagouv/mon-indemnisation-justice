{% extends 'base.html.twig' %}

{% set title = 'Créer un compte' %}

{% block stylesheets %}
    {{ parent() }}
    <script src="{{ asset('build/alpinejs/cdn.js') }}" defer></script>
    <style>
        /** Hack: maintenir les input de type checkbox et radio "cliquables". */
        input[type=radio], input[type=checkbox] {
            z-index: 2;
        }

        .pr-keyboard-hands .pic-keyboard-hands {
          background-image: url('{{ asset("images/picture/pic_keyboard-hands.jpg") }}');
          background-repeat: no-repeat;
          background-position: center;
          background-size: auto 100%;
          height: 870px;
            width:100%;
        }
        .pr-form-subscribe { border: 1px solid var(--pr-color-grey);  }
        .pr-form-subscribe_had-account { border-bottom: 1px solid var(--pr-color-grey); }


        .pr-form-subscribe, .pr-form-subscribe_had-account {
            border-bottom: 1px solid var(--pr-color-grey);
        }

        .fr-password__checkbox {
            order: inherit !important;
        }
    </style>
{% endblock %}

{% block containerClasses %}
{% endblock containerClasses %}

{% block main %}
<div class="pr-authentification">
    <div class="fr-container">
        <div class="fr-grid-row fr-mb-6w">
            <section class="pr-keyboard-hands fr-col-lg-6 fr-hidden fr-unhidden-lg">
                <div class="pic-keyboard-hands"></div>
            </section>
            <div class="fr-col-lg-6 fr-col-12">
                <section class="pr-form-subscribe" style="border: 1px solid var(--border-default-grey);">
                    <form method="POST"
                          action="{{ url(app.current_route) }}"
                          x-data="formulaireInscription()"
                          x-init="$watch('inscription', (inscription) => verifier(inscription))"
                          @submit.prevent="soumettre"
                    >
                        <input type="hidden" name="_token" value="{{ form._token.vars.value }}">
                        <div class="fr-grid-row">

                            <div class="pr-form-subscribe_had-account fr-col-12">
                                <div class="fr-p-4w">
                                    <h2 class="fr-text--sm">Vous possédez déjà un compte ?</h2>
                                    <a href="{{ url('app_login') }}" id="fr-button-:r0:" class="fr-btn fr-btn--secondary">Se connecter à mon espace</a>
                                </div>
                            </div>

                            <div class="fr-col-12">
                                <div class=" fr-p-0 fr-p-4w">
                                    <h2>Créer un compte</h2>
                                    <div id="fr-alert-:r1:" class="fr-alert fr-alert--info fr-alert--sm">
                                        <h3 class="fr-alert__title">Pourquoi ?</h3>
                                        <div>
                                            <p>L'accès au formulaire de demande d'indemnisation recquiert la création d'un compte</p>
                                        </div>
                                    </div>
                                    <p class="fr-my-4w">Sauf mention contraire, tous les champs sont obligatoires</p>
                                    <div class="fr-grid-row fr-grid-row--gutters">
                                        <div class="fr-col-lg-4 fr-col-12">
                                            <div id="fr-select-group-:r2:" class="fr-select-group">
                                                <label class="fr-label" for="select-:r3:">Civilité</label>
                                                <select name="civilite"
                                                        class="fr-select"
                                                        id="select-:r3:"
                                                        aria-describedby="select-:r4:-desc"
                                                        x-model="inscription.civilite"
                                                >
                                                    <option value="" disabled="" hidden=""></option>
                                                    <option value="M">Monsieur</option>
                                                    <option value="MME">Madame</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="fr-col-lg-8 fr-col-12">
                                            <div class="fr-input-group">
                                                <label class="fr-label" for="input-:r5:">Prénom(s)</label>
                                                <input name="prenom"
                                                       id="input-:r5:"
                                                       class="fr-input"
                                                       aria-describedby="input-:r5:-desc-error"
                                                       type="text"
                                                       value="{{ form.prenom.vars.value }}"
                                                       x-model="inscription.prenom"
                                                />
                                            </div>
                                        </div>
                                        <div class="fr-col-lg-6 fr-col-12">
                                            <div class="fr-input-group">
                                                <label class="fr-label" for="input-:r6:">Nom de naissance</label>
                                                <input name="nomNaissance"
                                                       id="input-:r6:"
                                                       class="fr-input"
                                                       aria-describedby="input-:r6:-desc-error"
                                                       type="text"
                                                       value="{{ form.nomNaissance.vars.value }}"
                                                       x-model="inscription.nomNaissance"
                                                />
                                            </div>
                                        </div>
                                        <div class="fr-col-lg-6 fr-col-12">
                                            <div class="fr-input-group">
                                                <label class="fr-label" for="input-:r7:">Nom d'usage</label>
                                                <input name="nom"
                                                       class="fr-input"
                                                       aria-describedby="input-:r7:-desc-error"
                                                       type="text"
                                                       id="input-:r7:"
                                                       value="{{ form.nom.vars.value }}"
                                                       x-model="inscription.nom"
                                                />
                                            </div>
                                        </div>
                                        <div class="fr-col-12">
                                            <div class="fr-input-group" :class="{ 'fr-input-group--error': !!erreurs?.courriel }">
                                                <label class="fr-label" for="input-:r8:">Adresse courriel</label>
                                                <input name="courriel"
                                                       id="input-:r8:"
                                                       class="fr-input"
                                                       :class="{ 'fr-input--error': !!erreurs?.courriel }"
                                                       aria-describedby="input-:r8:-desc-error"
                                                       type="text"
                                                       x-model="inscription.courriel"
                                                />
                                                <p id="input-:r8:-desc-error"
                                                   class="fr-error-text fr-hidden"
                                                   :class="{ 'fr-hidden' : !erreurs?.courriel }"
                                                   x-text="erreurs?.courriel"></p>
                                            </div>
                                        </div>
                                        {# Mot de passe #}
                                        <div class="fr-input-group fr-col-lg-6 fr-col-12">
                                            <div class="fr-password" id="password-input-:r9:" data-fr-js-password="true">
                                                <label class="fr-label" for="password-:ra:">Mot de passe<br/><br/></label>
                                                <div class="fr-input-wrap">
                                                    <input name="motDePasse"
                                                           class="fr-password__input fr-input"
                                                           :class="{ 'fr-input--error' : erreurs?.motDePasse }"
                                                           id="password-:ra:"
                                                           type="password"
                                                           :type="revelations.motDePasse ? 'text' : 'password'"
                                                           x-model="inscription.motDePasse" />
                                                </div>
                                                <div class="fr-password__checkbox fr-checkbox-group fr-checkbox-group--sm">
                                                    <input aria-label="Afficher le mot de passe"
                                                           id="password-:ra:-toggle-show"
                                                           type="checkbox"
                                                           x-model="revelations.motDePasse"
                                                    />
                                                    <label class="fr-password__checkbox fr-label"
                                                           for="password-:ra:-toggle-show"
                                                           x-text="revelations.motDePasse ? 'Masquer' : 'Afficher'"
                                                    >Afficher</label>
                                                </div>
                                                <p id="input-:ra:-desc-error"
                                                       class="fr-error-text fr-hidden"
                                                       :class="{ 'fr-hidden' : !erreurs?.motDePasse }"
                                                       x-text="erreurs?.motDePasse"></p>
                                            </div>
                                        </div>
                                        <div class="fr-input-group fr-col-lg-6 fr-col-12">
                                            <div class="fr-password"
                                                 id="password-input-:rb:"
                                                 data-fr-js-password="true">
                                                <label class="fr-label" style="width:100%;" for="password-:rc:">Confirmation du mot de passe</label>
                                                <div class="fr-input-wrap">
                                                    <input name="confirmation"
                                                           class="fr-password__input fr-input"
                                                           :class="{ 'fr-input--error' : erreurs?.confirmation }"
                                                           id="password-:rc:"
                                                           type="password"
                                                           :type="revelations.confirmation ? 'text' : 'password'"
                                                           x-model="inscription.confirmation" />
                                                </div>
                                                <div class="fr-password__checkbox fr-checkbox-group fr-checkbox-group--sm">
                                                    <input aria-label="Afficher le mot de passe"
                                                           id="password-:rc:-toggle-show" type="checkbox"
                                                           x-model="revelations.confirmation" />
                                                    <label class="fr-password__checkbox fr-label"
                                                           for="password-:rc:-toggle-show"
                                                           x-text="revelations.confirmation ? 'Masquer' : 'Afficher'"
                                                    >Afficher</label>
                                                </div>
                                                <p id="input-:rb:-desc-error"
                                                       class="fr-error-text fr-hidden"
                                                       :class="{ 'fr-hidden' : !erreurs?.confirmation }"
                                                       x-text="erreurs?.confirmation"></p>
                                            </div>
                                        </div>
                                        {# CGU #}
                                        <div class="fr-col-12">
                                            <fieldset id="fr-fieldset-checkbox-:rd:"
                                                      class="fr-fieldset"
                                                      aria-labelledby="fr-fieldset-checkbox-:rd:-messages">
                                                <div class="fr-fieldset__content">
                                                    <div class="fr-checkbox-group">
                                                        <input type="checkbox"
                                                               id="fr-fieldset-checkbox-:rd:-0"
                                                               name="cguOk" value="true"
                                                               x-model.boolean="inscription.cguOk" />
                                                        <label class="fr-label" for="fr-fieldset-checkbox-:rd:-0">
                                                            Je certifie avoir lu et accepté les
                                                            <a class="fr-link"
                                                               href="/conditions-generales-d-utilisation"
                                                               target="_blank">Conditions générales
                                                                d'utilisation</a>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="fr-messages-group"
                                                     id="fr-fieldset-checkbox-:rd:-messages"
                                                     aria-live="assertive"></div>
                                            </fieldset>
                                        </div>
                                        <div class="fr-col-12">
                                            <button class="fr-btn" :disabled="!submissible">Valider mon inscription et
                                                poursuivre ma demande
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </section>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script id="input-inscription" type="application/json">{{ inscription | json_encode | raw }}</script>
    <script id="input-erreurs" type="application/json">{{ errors | json_encode | raw }}</script>
    <script type="text/javascript">
        const inscription = Object.assign(
            {
                prenom: "",
                nom: "",
                nomNaissance: "",
                courriel: "",
                motDePasse: "",
                confirmation: "",
                cguOk: false
            },
            JSON.parse(document.getElementById('input-inscription')?.textContent || "{}")
        );
        const erreurs = Object.assign({}, JSON.parse(document.getElementById('input-erreurs')?.textContent || "{}"));

        function formulaireInscription() {
            return {
                erreurs: {...erreurs},
                submissible: false,
                inscription: {...inscription},
                avant: {},
                revelations: {
                    motDePasse: false,
                    confirmation: false,
                },
                estRempli(valeur) {
                    return !!valeur && valeur.trim().length > 0;
                },
                estCourrielValide(valeur) {
                    return !!valeur && valeur.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);
                },
                verifier(inscription) {
                    if (this.avant?.prenom !== inscription.prenom) {
                        if (!this.estRempli(inscription.prenom)) {
                            this.erreurs.prenom = "";
                        } else {
                            delete this.erreurs.prenom;
                        }
                    }

                    if (this.avant?.nom !== inscription.nom) {
                        if (!this.estRempli(inscription.nom)) {
                            this.erreurs.nom = "";
                        } else {
                            delete this.erreurs.nom;
                        }
                    }

                    if (this.avant?.courriel !== inscription.courriel) {
                        if (!this.estCourrielValide(inscription.courriel)) {
                            this.erreurs.courriel = inscription.courriel ? "L'adresse courriel n'est pas valide" : false;
                        } else {
                            delete this.erreurs.courriel;
                        }
                    }

                    // Vérification du mot de passe:
                    if (
                        (this.avant?.motDePasse !== inscription.motDePasse) ||
                        (this.avant?.confirmation !== inscription.confirmation)
                    ) {
                        delete this.erreurs.motDePasse;
                        delete this.erreurs.confirmation;
                        if (inscription.motDePasse.length < 8) {
                            this.erreurs.motDePasse = false;
                        } else if (!inscription.motDePasse.match(/\d/)) {
                            this.erreurs.motDePasse = "Votre mot de passe doit contenir au moins 1 chiffre";
                        } else if (this.estRempli(inscription.motDePasse) && inscription.confirmation !== inscription.motDePasse) {
                            this.erreurs.confirmation = "Les deux mots de passe doivent être identiques";
                        }
                    }

                    if (this.avant?.cguOk !== inscription.cguOk) {
                        if (!inscription.cguOk) {
                            this.erreurs.cguOk = "";
                        } else {
                            delete this.erreurs.cguOk;
                        }
                    }

                    this.submissible = Object.keys(this.erreurs).length === 0;

                    this.avant = {...inscription};
                },
                soumettre(event) {
                    if (this.submissible) {
                        event.target.closest('form')?.submit();
                    }
                },
            };
        };
    </script>
{% endblock javascripts %}