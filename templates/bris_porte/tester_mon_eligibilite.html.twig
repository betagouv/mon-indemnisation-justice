{% extends 'base.html.twig' %}

{% block title %}Bris de porte : tester mon éligibilité{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <script src="{{ asset('build/alpinejs/cdn.js') }}" defer></script>
    <style>
        /* AlpineJS */
        [x-cloak] {
            display: none !important;
        }
    </style>
{% endblock stylesheets %}

{% block main %}
    <div class="fr-container fr-my-3w">
        {#  Indicateur d'étapes #}
        <div class="fr-stepper">
            <h2 class="fr-stepper__title">
                Tester mon éligibilité
                <span class="fr-stepper__state">Étape 1 sur 3</span>
            </h2>
            <div class="fr-stepper__steps" data-fr-current-step="1" data-fr-steps="3"></div>
            <p class="fr-stepper__details">
                <span class="fr-text--bold">Étape suivante :</span> Création de mon compte
            </p>
        </div>

        <div class="fr-col-12">


            {# Formulaire #}
            <form
                name="eligibilite-test-form"
                action="{{ url(app.current_route) }}"
                method="POST"
                x-data="eligibiliteTestForm()"
                x-init="$watch('reponses', (reponses) => statuer(reponses))"
            >

                {# Questions #}
                <div
                    class="fr-col-12"
                    x-show="questions.dateOperationPJ(reponses)"
                >
                    <div class="fr-input-group">
                        <label class="fr-label" for="eligibilite-test-form-date-operation-pj">
                            Quand la porte de votre logement a-t-elle été fracturé par les forces de police ?
                        </label>
                        <div class="fr-col-lg-6 fr-mt-1w">
                        <input
                            class="fr-input"
                            id="eligibilite-test-form-date-operation-pj"
                            type="date"
                            x-model="reponses.dateOperationPJ"
                            :disabled="decision"
                        >
                    </div>

                </div>

                <div
                    class="fr-col-12"
                    x-show="questions.estVise(reponses)"
                    x-model.boolean="reponses.estVise"
                    x-transition.duration.500ms
                >
                    <fieldset
                        class="fr-fieldset"
                        aria-labelledby="checkboxes-inline-legend"

                    >
                        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="checkboxes-inline-legend">
                            Êtes-vous la personne visée par l'opération des forces de l'ordre ?
                        </legend>
                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-vise-oui"
                                    value="true"
                                    :checked="reponses.estVise === true"
                                    :disabled="decision || reponses?.estVise != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-vise-oui" >Oui</label>
                            </div>
                        </div>

                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-vise-non"
                                    value="false"
                                    :checked="reponses.estVise === false"
                                    :disabled="decision || reponses?.estVise != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-vise-non" >Non</label>
                            </div>
                        </div>

                    </fieldset>
                </div>

                <div
                    class="fr-col-12"
                    x-show="questions.estRecherche(reponses)"
                    x-model.boolean="reponses.estRecherche"
                    x-transition.duration.500ms
                >
                    <fieldset
                        class="fr-fieldset"
                        aria-labelledby="checkboxes-inline-legend"
                    >
                        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="checkboxes-inline-legend">
                            Est-ce que la personne recherchée réside ou est hébergée à cette adresse ?
                        </legend>
                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-recherche-oui"
                                    value="true"
                                    :checked="reponses.estRecherche === true"
                                    :disabled="decision || reponses?.estRecherche != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-recherche-oui" >Oui</label>
                            </div>
                        </div>

                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-recherche-non"
                                    value="false"
                                    :checked="reponses.estRecherche === false"
                                    :disabled="decision || reponses?.estRecherche != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-recherche-non" >Non</label>
                            </div>
                        </div>
                    </fieldset>
                </div>

                <div
                    class="fr-col-12"
                    x-show="questions.estProprietaire(reponses)"
                    x-model.boolean="reponses.estProprietaire"
                    x-transition.duration.500ms
                >
                    <fieldset
                        class="fr-fieldset"
                        aria-labelledby="checkboxes-inline-legend"
                    >
                        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="checkboxes-inline-legend">
                            Quel est votre statut par rapport au logement ?
                        </legend>
                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-proprietaire-oui"
                                    value="true"
                                    :checked="reponses.estProprietaire === true"
                                    :disabled="decision || reponses.estProprietaire != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-proprietaire-oui" >Propriétaire</label>
                            </div>
                        </div>

                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-est-proprietaire-non"
                                    value="false"
                                    :checked="reponses.estProprietaire === true"
                                    :disabled="decision || reponses.estProprietaire != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-est-proprietaire-non" >Locataire</label>
                            </div>
                        </div>

                    </fieldset>
                </div>

                <div
                    class="fr-col-12"
                    x-show="questions.aContacteAssurance(reponses)"
                    x-model.boolean="reponses.aContacteAssurance"
                    x-transition.duration.500ms
                >
                    <fieldset
                        class="fr-fieldset"
                        aria-labelledby="checkboxes-inline-legend"
                    >
                        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="checkboxes-inline-legend">
                            Avez-vous contacté votre assurance habitation et obtenu, si nécessaire, une attestation de non prise en charge du sinistre ?
                        </legend>
                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-a-contacte-assurance-oui"
                                    value="true"
                                    :checked="reponses.aContacteAssurance === true"
                                    :disabled="decision || reponses?.aContacteAssurance != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-a-contacte-assurance-oui" >Oui</label>
                            </div>
                        </div>

                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-a-contacte-assurance-non"
                                    value="false"
                                    :checked="reponses.aContacteAssurance === false"
                                    :disabled="decision || reponses?.aContacteAssurance != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-a-contacte-assurance-non" >Non</label>
                            </div>
                        </div>

                    </fieldset>
                </div>

                <div
                    class="fr-col-12"
                    x-show="questions.aContacteBailleur(reponses)"
                    x-transition.duration.500ms
                >
                    <fieldset
                        class="fr-fieldset"
                        aria-labelledby="checkboxes-inline-legend"
                    >
                        <legend class="fr-fieldset__legend--regular fr-fieldset__legend" id="checkboxes-inline-legend">
                            Avez-vous pris contact avec votre bailleur car celui-ci a, à votre égard, une obligation de sécurité (article 170 du code civil) ?
                        </legend>
                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-a-contacte-bailleur-oui"
                                    value="true"
                                    :checked="reponses.aContacteBailleur === true"
                                    :disabled="decision || reponses?.aContacteBailleur != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-a-contacte-bailleur-oui" >Oui</label>
                            </div>
                        </div>

                        <div class="fr-fieldset__element fr-fieldset__element--inline">
                            <div class="fr-checkbox-group">
                                <input
                                    id="eligibilite-test-form-a-contacte-bailleur-non"
                                    value="false"
                                    :checked="reponses.aContacteBailleur === true"
                                    :disabled="decision || reponses?.aContacteBailleur != null"
                                    type="checkbox"
                                />
                                <label class="fr-label" for="eligibilite-test-form-a-contacte-bailleur-non" >Non</label>
                            </div>
                        </div>

                    </fieldset>
                </div>

                {# Décisions #}
                <div
                    class="fr-alert fr-my-2w fr-alert--error"
                    x-show="decision?.name === 'error_est_vise'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        Vous n'êtes pas éligible
                    </h3>
                    <p>
                        [REFUS EST VISÉ]
                    </p>
                    <p>
                        En étant concerné par l'opération de police judiciaire, vous ne pouvez prétendre à une quelconque indemnisation.
                    </p>
                </div>

                <div
                    class="fr-alert fr-my-2w fr-alert--error"
                    x-show="decision?.name === 'error_est_recherche'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        Vous n'êtes pas éligible
                    </h3>
                    <p>
                        [REFUS EST RECHERCHÉ]
                    </p>
                    <p>
                        Si la personne recherchée réside oh est hébergée dans le logement dont la porte a été fracturée dans le cadre l'opération de police judiciaire, vous ne pouvez prétendre à une quelconque indemnisation.
                    </p>
                </div>

                <div
                    class="fr-alert fr-my-2w fr-alert--warning"
                    x-show="decision?.name === 'warning_proprietaire_assurance'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        [Inciter la démarche 4]
                    </h3>
                    <p>
                        Propriétaire rapprochez-vous de votre assurance habitation.
                    </p>
                </div>

                <div
                    class="fr-alert fr-my-2w fr-alert--warning"
                    x-show="decision?.name === 'warning_locataire_assurance'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        [Inciter la démarche 6]
                    </h3>
                    <p>
                        Locataire rapprochez-vous de votre assurance habitation.
                    </p>
                </div>

                <div
                    class="fr-alert fr-my-2w fr-alert--warning"
                    x-show="decision?.name === 'warning_locataire_bailleur'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        [Inciter la démarche 8]
                    </h3>
                    <p>
                        Locataire rapprochez-vous de votre assurance habitation.
                    </p>
                </div>

                <div
                    class="fr-alert fr-my-2w fr-alert--success"
                    x-show="decision?.name === 'success'"
                    x-cloak
                >
                    <h3 class="fr-alert__title">
                        Vous êtes éligible
                    </h3>
                    <p>
                        [OK]
                    </p>
                    <p>
                        Vous remplissez tous les critères pour déposer un dossier de demande d'indemnisation.
                    </p>
                    <p>
                        Nous vous invitons à créer un compte dès maintenant en cliquant sur le bouton ci-dessous.
                    </p>
                </div>


                {# Boutons #}

                <div class="fr-btns-group fr-btns-group--right fr-btns-group--inline-lg">
                    <button
                        x-show="true"
                        x-cloak
                        class="fr-btn fr-btn--tertiary-no-outline"
                        aria-controls="modale-test-eligibilite"
                        data-fr-js-modal-button="true"
                        @click="reinitialiser()"
                        type="button"
                    >Recommencer
                    </button>
                    <button
                        class="fr-btn"
                        type="submit"
                        :disabled="!decision || !(decision?.eligible ?? true)"
                        x-cloak
                    >Faire ma demande
                    </button>

                </div>
            </form>
        </div>
    </div>
{% endblock main %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
        function eligibiliteTestForm() {

            return {
                reponses: {
                    dateOperationPJ: null,
                    estVise: null,
                    estRecherche: null,
                    estProprietaire: null,
                    aContacteAssurance: null,
                    aContacteBailleur: null,
                },
                questions: {
                    dateOperationPJ: (_) => true,
                    estVise: (reponses) => reponses.dateOperationPJ != null,
                    estRecherche: (reponses) => reponses.estVise === false,
                    estProprietaire: (reponses) => reponses.estRecherche === false,
                    aContacteAssurance: (reponses) => reponses.estProprietaire != null,
                    aContacteBailleur: (reponses) => reponses.aContacteAssurance && reponses.estProprietaire === false
                },
                decision: null,
                statuer(reponses) {
                    // Statuer sur une décision ici :
                    if (reponses.estVise) {
                        this.decision = {
                            name: "error_est_vise",
                            eligible: false
                        };
                    } else if (reponses.estRecherche) {
                        this.decision = {
                            name: "error_est_recherche",
                            eligible: false
                        };
                    } else {
                        if (reponses.estProprietaire) {
                            if (reponses?.aContacteAssurance != null) {
                                this.decision = {
                                    name: reponses.aContacteAssurance ? 'success' : 'warning_proprietaire_assurance'
                                };
                            }
                        } else if (reponses.estProprietaire === false) {
                            if (reponses?.aContacteAssurance === false) {
                                this.decision = {
                                    name: "warning_locataire_assurance"
                                };

                            } else if (reponses?.aContacteAssurance) {
                                if (reponses?.aContacteBailleur != null) {
                                    this.decision = {
                                        name: reponses?.aContacteBailleur ? 'success' : 'warning_locataire_bailleur'
                                    };
                                }
                            }
                        }
                    }
                },
                reinitialiser() {
                    Object.keys(this.reponses).forEach((c) => this.reponses[c] = null);
                    this.decision = null;
                }
            };
        };
    </script>
{% endblock javascripts %}
