stages:
  - "ðŸ”¨ build"
  - "ðŸš€ deploy"


build:
  stage: "ðŸ”¨ build"
  variables:
    APP_ENV: test
    DATABASE_URL: pgsql://precontest:precontest@postgres:5432/precontest?serverVersion=15
    COMPOSER_ALLOW_SUPERUSER: 1
    POSTGRES_DB: precontest
    POSTGRES_PASSWORD: precontest
    POSTGRES_USER: precontest
  services:
    - postgres:15-alpine
  image:
    name: php:8.2
  before_script:
    # Install required system packages
    - apt update -yqq
    - apt-get install -y zlib1g-dev libicu-dev g++ libpq-dev libzip-dev zip libldap2-dev libldap-common libfreetype6-dev libjpeg62-turbo-dev libpng-dev
    # Install PHP extensions
    - docker-php-ext-install zip
    - docker-php-ext-install intl
    - docker-php-ext-install calendar
    - docker-php-ext-install gd
    - docker-php-ext-configure pgsql -with-pgsql=/usr/local/pgsql
    - docker-php-ext-install pdo pdo_pgsql pgsql
    - docker-php-ext-install sysvsem
    - docker-php-ext-configure ldap --with-libdir=lib/$(uname -m)-linux-gnu/
    - docker-php-ext-install ldap
    # Install composer
    - curl -sS https://getcomposer.org/installer | php
    # Install all project dependencies
    - php composer.phar install --no-interaction

  script:
    - echo "Building"
    - bin/console cache:clear
    - bin/phpunit
  artifacts:
    paths:
      - vendor/
      - public/
      - .env*
      - composer.lock
    expire_in: 05 min
  cache:
    paths:
      - vendor/

.base-deploy:
  stage: "ðŸš€ deploy"
  image:
    name: clevercloud/clever-tools:latest
  needs:
    - job: build
  script:
    - echo "Package"
    - echo $FOO
    - echo $CC_APP_ID
    - echo APP ID ${CC_APP_ID}
    - clever link "${CC_APP_ID}"
    - clever deploy

deploy-develop:
  extends: .base-deploy
  variables:
    CC_APP_ID: ${CC_APP_DEV_ID}
    FOO: "bar"
  only:
    - develop
